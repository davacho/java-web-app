def ansibleSERVER = 'ubuntu@3.9.165.153'
pipeline {
  agent any
  tools {
    maven 'maven'
  }
  stages {
    stage('Code analysis') {
      steps {
        withSonarQubeEnv(installationName: 'sonar') { 
          sh 'mvn clean sonar:sonar'
        }
      }
    }
    stage("Quality Gate") {
      steps {
        timeout(time: 2, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }
   stage('Build Code'){
     steps {
       echo "packaging the application"
       sh 'mvn clean package'
       }
    }
   stage('Send Artifacts to Ansible Server') {
     steps { 
       sshagent(['ansible-key']) {
         sh "scp -o StrictHostKeyChecking=no target/spring-petclinic-*.war  ${ansibleSERVER}:/home/ubuntu"
       }
     }
   }
 }
}
